name: Docker CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4 # Updated to v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven # ENABLE CACHING to save time

      - name: Run Maven Tests
        env:
          # Database (Matches Service)
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/test_db
          SPRING_DATASOURCE_USERNAME: test_user
          SPRING_DATASOURCE_PASSWORD: test_password
          # REQUIRED: Dummy values to prevent ApplicationContext startup failure
          JWT_SECRET: "test_secret_key_for_ci_pipeline_only_12345"
          APP_ADMIN_BOOTSTRAP_PASSWORD: "TestAdminPassword123!"
          GOOGLE_CLIENT_ID: "dummy-google-client-id"
          GOOGLE_CLIENT_SECRET: "dummy-google-client-secret"
          SPRING_MAIL_USERNAME: "dummy@email.com"
          SPRING_MAIL_PASSWORD: "dummy-password"
        run: mvn verify # 'verify' runs tests and integration tests

  docker-smoke-test:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Create .env file for Docker
        run: |
          # Create a real .env file with values so containers don't crash
          echo "POSTGRES_DB=application_portal_db" >> .env
          echo "POSTGRES_USER=postgres" >> .env
          echo "POSTGRES_PASSWORD=secure_ci_password" >> .env
          echo "BACKEND_PORT=8080" >> .env
          echo "JWT_SECRET=ci_jwt_secret_key_12345" >> .env
          echo "APP_ADMIN_BOOTSTRAP_PASSWORD=admin123" >> .env
          echo "GOOGLE_CLIENT_ID=dummy" >> .env
          echo "GOOGLE_CLIENT_SECRET=dummy" >> .env
          echo "SPRING_MAIL_USERNAME=dummy" >> .env
          echo "SPRING_MAIL_PASSWORD=dummy" >> .env
          echo "LOGGING_LEVEL_COM_IGIRERWANDA=INFO" >> .env

      - name: Build and Start Containers
        # --build forces the image to be built using the local Dockerfile
        # --abort-on-container-exit stops if the backend crashes immediately
        run: docker compose up -d --build

      - name: Health Check (Wait for Backend)
        run: |
          echo "Waiting for backend to start..."
          sleep 45 # Give Spring Boot time to start inside the container
          docker compose ps
          docker compose logs backend # Inspect logs if it fails

      - name: Tear Down
        if: always() # Run this even if previous steps fail
        run: docker compose down -v